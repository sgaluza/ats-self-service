// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users are managed by Supabase Auth
// This extends the auth.users table
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  role      UserRole @default(USER)
  status    UserStatus @default(ACTIVE)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  wireguardConfigs WireguardConfig[]
  invitationsCreated Invitation[] @relation("InvitationCreator")
  invitationUsed Invitation? @relation("InvitationUser")
  auditLogs AuditLog[] @relation("UserAuditLogs")
  adminAuditLogs AuditLog[] @relation("AdminAuditLogs")

  @@map("users")
}

enum UserRole {
  ADMIN
  USER
}

enum UserStatus {
  ACTIVE
  BLOCKED
  DELETED
}

model Invitation {
  id        String   @id @default(uuid())
  key       String   @unique
  email     String?
  status    InvitationStatus @default(ACTIVE)
  createdAt DateTime @default(now()) @map("created_at")
  usedAt    DateTime? @map("used_at")
  expiresAt DateTime? @map("expires_at")

  createdById String @map("created_by_id")
  createdBy User @relation("InvitationCreator", fields: [createdById], references: [id])

  usedById String? @unique @map("used_by_id")
  usedBy User? @relation("InvitationUser", fields: [usedById], references: [id])

  @@map("invitations")
}

enum InvitationStatus {
  ACTIVE
  USED
  REVOKED
  EXPIRED
}

model WireguardConfig {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  deviceName    String   @map("device_name")
  publicKey     String   @unique @map("public_key")
  privateKey    String   @map("private_key")
  presharedKey  String   @map("preshared_key")
  serverIp      String   @map("server_ip")
  serverPort    Int      @map("server_port")
  peerIp        String   @unique @map("peer_ip")
  containerId   String?  @unique @map("container_id")
  status        ConnectionStatus @default(PENDING)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  proxyConfig ProxyConfig?
  connectionStats ConnectionStat[]

  @@map("wireguard_configs")
}

enum ConnectionStatus {
  PENDING
  CONNECTED
  DISCONNECTED
  ERROR
}

model ProxyConfig {
  id            String   @id @default(uuid())
  wireguardConfigId String @unique @map("wireguard_config_id")
  username      String
  password      String
  host          String
  port          Int
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  wireguardConfig WireguardConfig @relation(fields: [wireguardConfigId], references: [id], onDelete: Cascade)

  @@map("proxy_configs")
}

model ConnectionStat {
  id            String   @id @default(uuid())
  wireguardConfigId String @map("wireguard_config_id")
  timestamp     DateTime @default(now())
  status        ConnectionStatus
  bytesSent     BigInt   @default(0) @map("bytes_sent")
  bytesReceived BigInt   @default(0) @map("bytes_received")
  speedMbps     Float?   @map("speed_mbps")
  latencyMs     Int?     @map("latency_ms")

  wireguardConfig WireguardConfig @relation(fields: [wireguardConfigId], references: [id], onDelete: Cascade)

  @@index([wireguardConfigId, timestamp])
  @@map("connection_stats")
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  adminId     String?  @map("admin_id")
  action      String
  entityType  String   @map("entity_type")
  entityId    String?  @map("entity_id")
  details     Json?
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  user  User? @relation("UserAuditLogs", fields: [userId], references: [id])
  admin User? @relation("AdminAuditLogs", fields: [adminId], references: [id])

  @@index([userId, createdAt])
  @@index([adminId, createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}
